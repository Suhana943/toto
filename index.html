<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cyber Security Awareness & AI Tutor</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://code.iconify.design/iconify-icon/1.0.7/iconify-icon.min.js"></script>
    <style>
        /* Base Styles & Variables (Combined) */
        :root {
            --primary-blue: #1691fd;
            --secondary-yellow: #ebab0c;
            --light-blue-bg: #d9eff8; /* For bot messages */
            --text-dark: #333;
            --text-light: #fff;
            --gray-text: #555;
            --light-bg: #f0f8ff; /* Body background */
            --white: #ffffff;
            --border-radius-md: 20px;
            --border-radius-lg: 40px;
            --transition-speed: 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: "Poppins", sans-serif;
            line-height: 1.6;
            color: var(--text-dark);
            background-color: var(--light-bg);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        a {
            text-decoration: none;
            color: inherit;
            transition: opacity var(--transition-speed);
        }

        a:hover {
            opacity: 0.8;
        }

        /* --- Global Utility Classes --- */
        .btn {
            padding: 12px 25px;
            border-radius: var(--border-radius-md);
            border: none;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all var(--transition-speed);
        }

        .btn_primary { /* Styled like your previous "send" button */
            background-color: var(--secondary-yellow);
            color: var(--white);
        }
        .btn_primary:hover {
            background-color: #d89e0b; /* Slightly darker yellow */
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .flex {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .flex_content {
            flex: 1; /* Allow flex items to grow and shrink */
            min-width: 300px; /* Minimum width for flex items before wrapping */
        }

        .padding_2 {
            padding: 20px;
        }

        .linear_text {
            background: linear-gradient(to right, var(--primary-blue), #00c6ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            color: transparent;
        }

        /* --- Navbar Styles --- */
        nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 40px;
            background-color: var(--white);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            flex-wrap: wrap;
        }

        nav .logo img {
            height: 40px;
            display: block;
        }

        nav .links {
            display: flex;
            list-style: none;
            gap: 30px;
        }

        nav .links a {
            font-weight: 500;
            color: var(--text-dark);
            position: relative;
        }

        nav .links a.active::after {
            content: '';
            position: absolute;
            left: 0;
            bottom: -5px;
            width: 100%;
            height: 2px;
            background-color: var(--primary-blue);
            transform: scaleX(0);
            transform-origin: bottom right;
            transition: transform 0.3s ease-out;
        }

        nav .links a.active {
            color: var(--primary-blue);
        }

        nav .links a.active::after {
            transform: scaleX(1);
            transform-origin: bottom left;
        }

        nav .icon_buttons {
            list-style: none;
        }

        /* --- Header/Hero Section Styles --- */
        header {
            padding: 60px 40px;
            text-align: center;
            flex-grow: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        header .flex {
            max-width: 1200px;
            margin: 0 auto;
            align-items: center;
        }

        header .flex_content:nth-child(2) { /* For the image */
            display: flex;
            justify-content: center;
            align-items: center;
        }

        header img {
            max-width: 100%;
            height: auto;
            border-radius: var(--border-radius-md);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        header h1 {
            font-size: 3.5rem;
            margin-bottom: 20px;
            line-height: 1.2;
            font-weight: 700;
        }

        header p {
            font-size: 1.1rem;
            color: var(--gray-text);
            margin-bottom: 30px;
        }

        header .lists {
            list-style: none;
            text-align: left;
            padding-left: 0;
        }

        header .list {
            background-color: var(--white);
            padding: 15px 20px;
            border-radius: var(--border-radius-md);
            margin-bottom: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            font-weight: 500;
            color: var(--primary-blue);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        header .list::before {
            content: "\f00c"; /* FontAwesome checkmark */
            font-family: "Font Awesome 6 Free";
            font-weight: 900;
            color: var(--secondary-yellow);
        }

        /* --- Footer Styles --- */
        footer {
            padding: 20px;
            text-align: center;
            color: var(--text-dark);
            background-color: var(--white);
            border-top: 1px solid #eee;
            margin-top: auto;
        }

        /* --- Credits Styles --- */
        .credits {
            background-color: var(--white);
            color: var(--text-dark);
            padding: 0.3rem 1rem;
            position: fixed;
            z-index: 99999 !important;
            bottom: 1rem;
            right: 0;
            font-size: 13px;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            flex-direction: row;
            max-width: 250px;
            gap: 10px;
            border-top-left-radius: var(--border-radius-md);
            border-bottom-left-radius: var(--border-radius-md);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .credits a {
            color: var(--text-dark);
            opacity: 0.7;
            position: relative;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 2px;
            white-space: nowrap;
        }

        .credits a:not(:last-child):after {
            content: ",";
            margin-right: 5px;
        }

        .credits a:hover {
            opacity: 1;
        }

        /* --- AI Language Tutor Modal Styles --- */
        .tutor-modal-overlay {
            display: none; /* Hidden by default */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .language-tutor-container {
            background-color: var(--white);
            border-radius: var(--border-radius-lg);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.25);
            max-width: 700px;
            width: 100%;
            height: 700px; /* Fixed height for the tutor window */
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        .tutor-header {
            background-color: var(--primary-blue);
            color: var(--text-light);
            padding: 20px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1.3rem;
            font-weight: 600;
            border-top-left-radius: var(--border-radius-lg);
            border-top-right-radius: var(--border-radius-lg);
        }

        .tutor-header h3 {
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .tutor-header .fas {
            font-size: 1.1em;
        }

        .close-tutor-btn {
            background: none;
            border: none;
            color: var(--text-light);
            font-size: 1.5rem;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .close-tutor-btn:hover {
            transform: rotate(90deg);
        }

        .chat-display {
            flex-grow: 1;
            padding: 25px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
            font-size: 1rem;
            background-color: #fcfdff;
            scroll-behavior: smooth;
        }

        .message {
            padding: 15px 20px;
            border-radius: 25px;
            max-width: 80%;
            line-height: 1.5;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .bot-message {
            background-color: var(--light-blue-bg);
            align-self: flex-start;
            border-bottom-left-radius: 8px;
            color: var(--text-dark);
        }

        .user-message {
            background-color: var(--primary-blue);
            color: var(--text-light);
            align-self: flex-end;
            border-bottom-right-radius: 8px;
        }

        .tutor-input {
            display: flex;
            padding: 20px 25px;
            border-top: 1px solid #e0e0e0;
            background-color: var(--white);
            gap: 15px;
            align-items: flex-end;
        }

        .tutor-input textarea {
            flex-grow: 1;
            border: 1px solid #ccc;
            border-radius: var(--border-radius-md);
            padding: 12px 18px;
            font-family: "Poppins", sans-serif;
            font-size: 1rem;
            min-height: 50px;
            max-height: 120px;
            resize: vertical;
            outline: none;
            transition: border-color var(--transition-speed), box-shadow var(--transition-speed);
        }

        .tutor-input textarea:focus {
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(22, 145, 253, 0.2);
        }

        .loading-indicator {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(255, 255, 255, 0.95);
            padding: 20px 30px;
            border-radius: var(--border-radius-md);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            font-weight: 500;
            color: var(--primary-blue);
            z-index: 10;
        }

        .loading-indicator i {
            margin-right: 10px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            color: #dc3545;
            margin-top: 15px;
            font-weight: 500;
            text-align: center;
            padding: 0 20px;
        }

        /* --- Responsive Adjustments (Combined and Refined) --- */
        @media (max-width: 992px) {
            nav {
                padding: 15px 20px;
                flex-direction: column;
                gap: 15px;
            }
            nav .links {
                justify-content: center;
                flex-wrap: wrap;
                gap: 20px;
            }
            header {
                padding: 40px 20px;
            }
            header .flex {
                flex-direction: column;
            }
            header .flex_content {
                min-width: unset;
                width: 100%;
                text-align: center;
            }
            header .flex_content:nth-child(1),
            header .flex_content:nth-child(2) {
                order: unset; /* Reset order for smaller screens */
            }
            header h1 {
                font-size: 2.5rem;
            }
            header p {
                font-size: 1rem;
            }
            header .lists {
                text-align: center; /* Center list items when stacked */
                padding: 0 10px;
            }
            .language-tutor-container {
                max-width: 95%;
                height: 80vh;
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 0;
            }
            .language-tutor-container {
                width: 98%;
                height: 90vh;
                border-radius: var(--border-radius-md);
            }
            .tutor-header {
                font-size: 1.1rem;
                padding: 15px 20px;
                border-top-left-radius: var(--border-radius-md);
                border-top-right-radius: var(--border-radius-md);
            }
            .close-tutor-btn {
                font-size: 1.2rem;
            }
            .chat-display {
                padding: 15px;
                gap: 10px;
            }
            .message {
                padding: 12px 15px;
                font-size: 0.9rem;
            }
            .tutor-input {
                padding: 15px 20px;
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
            }
            .tutor-input textarea {
                min-height: 40px;
                max-height: 80px;
            }
            .btn {
                width: 100%;
                padding: 10px 15px;
            }
            .loading-indicator {
                padding: 15px 20px;
                font-size: 0.9rem;
            }
        }

        @media (max-width: 480px) {
            nav {
                padding: 10px 15px;
            }
            nav .links {
                gap: 15px;
            }
            header {
                padding: 30px 15px;
            }
            header h1 {
                font-size: 2rem;
            }
            header p {
                font-size: 0.9rem;
            }
            .language-tutor-container {
                height: 95vh;
            }
            .tutor-header {
                font-size: 1rem;
                padding: 12px 15px;
            }
            .chat-display {
                font-size: 0.85rem;
                padding: 10px;
            }
            .message {
                max-width: 90%;
            }
            .tutor-input {
                padding: 10px 15px;
                gap: 8px;
            }
            .tutor-input textarea {
                min-height: 35px;
                max-height: 70px;
                padding: 10px 12px;
            }
            .btn {
                padding: 8px 12px;
                font-size: 0.9rem;
            }
            .credits {
                font-size: 11px;
                padding: 0.2rem 0.8rem;
                bottom: 0.5rem;
                max-width: 200px;
            }
        }
    </style>
</head>
<body>
    <nav>
        <div class="logo">
            <a href="#">
                <img src="https://assets.website-files.com/62e846062f7a1f2647752601/62e846062f7a1f33f975260e_logo.svg" loading="lazy" alt="Logo">
            </a>
        </div>
        <ul class="links">
            <li><a href="#" class="active">Home</a></li>
            <li><a href="#">Resources</a></li>
            <li><a href="#">Courses</a></li>
            <li><a href="#">About Us</a></li>
            <li><a href="#">Contact</a></li>
        </ul>
        <ul class="icon_buttons">
            <li>
                <button class="btn btn_primary" onclick="openAITutorModal()">
                    <i class="fas fa-language"></i> Open AI Tutor
                </button>
            </li>
        </ul>
    </nav>

    <header>
        <div class="flex">
            <div class="flex_content">
                <h1>Stay <span class="linear_text">Safe</span> Online with Our Cyber Security Awareness Programs</h1>
                <p>Equip yourself with essential knowledge and practical skills to protect your digital life from evolving cyber threats. Start your journey to a more secure online presence today!</p>
                <button class="btn btn_primary">
                    <iconify-icon icon="ic:baseline-security"></iconify-icon> Learn More
                </button>
                <ul class="lists padding_2">
                    <li class="list">Phishing Attack Prevention</li>
                    <li class="list">Strong Password Management</li>
                    <li class="list">Data Privacy Fundamentals</li>
                    <li class="list">Secure Browse Habits</li>
                </ul>
            </div>
            <div class="flex_content">
                <img src="https://uploads.onecompiler.io/43qbxf9xj/43qbxefpn/Screenshot%202025-07-11%20121007.png" alt="Cyber Security Awareness Image" loading="lazy">
            </div>
        </div>
    </header>

    <footer>
        <p>&copy; 2025 CyberSafe Inc. All rights reserved.</p>
    </footer>

    <div class="tutor-modal-overlay" id="aiTutorModal">
        <div class="language-tutor-container">
            <div class="tutor-header">
                <h3><i class="fas fa-language"></i> AI Language Tutor</h3>
                <button class="close-tutor-btn" aria-label="Close tutor"><i class="fas fa-times"></i></button>
            </div>
            <div class="chat-display" id="chatDisplay">
                </div>
            <div class="tutor-input">
                <textarea id="userInput" placeholder="Type your answer or question here..." rows="1"></textarea>
                <button id="sendBtn" class="btn"><i class="fas fa-paper-plane"></i> Send</button>
            </div>

            <div id="loadingIndicator" class="loading-indicator">
                <i class="fas fa-spinner"></i> AI is thinking...
            </div>
            <p id="errorMessage" class="error-message" style="display: none;"></p>
        </div>
    </div>

    <div class="credits">
        <a href="https://www.linkedin.com/in/mohit-mishra-73335527a/" target="_blank">
            <iconify-icon icon="mdi:linkedin"></iconify-icon> Mohit Mishra
        </a>
        <a href="https://github.com/mohitm09" target="_blank">
            <iconify-icon icon="icon-park-outline:github"></iconify-icon> Github
        </a>
    </div>

    <script>
        // --- Global Variables and Constants ---
        const API_KEY = "AIzaSyCBSJI95ouerTIu0gDmwnNPApN3lKqamiA"; // <<< IMPORTANT: Replace with your actual API key
        // Updated to use gemini-2.0-flash model
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${API_KEY}`;

        // DOM Elements
        const aiTutorModal = document.getElementById('aiTutorModal');
        const closeTutorBtn = aiTutorModal.querySelector('.close-tutor-btn');
        const chatDisplay = document.getElementById('chatDisplay');
        const userInput = document.getElementById('userInput');
        const sendBtn = document.getElementById('sendBtn');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const errorMessage = document.getElementById('errorMessage');

        // Chat state
        let chatHistory = [];
        let lessonStage = 0; // 0: Greetings, 1: Asking how are you, 2: Introducing oneself

        // --- Modal Control Functions ---
        function openAITutorModal() {
            aiTutorModal.style.display = 'flex';
            if (chatHistory.length === 0) { // Only add initial messages if chat is empty
                initializeChatHistory();
            }
            userInput.focus();
        }

        function closeAITutorModal() {
            aiTutorModal.style.display = 'none';
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel(); // Stop speaking if closing
            }
        }

        // --- Chat UI Management ---
        function addMessage(text, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message', `${sender}-message`);
            messageDiv.textContent = text;
            chatDisplay.appendChild(messageDiv);
            chatDisplay.scrollTop = chatDisplay.scrollHeight; // Auto-scroll to bottom
        }

        function showLoading(show) {
            loadingIndicator.style.display = show ? 'flex' : 'none';
            sendBtn.disabled = show; // Disable send button while loading
            userInput.disabled = show; // Disable input while loading
        }

        function showErrorMessage(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
        }

        function hideErrorMessage() {
            errorMessage.style.display = 'none';
        }

        // --- Speech Synthesis ---
        function speakText(text) {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'es-ES'; // Set language for Spanish
                window.speechSynthesis.speak(utterance);
            } else {
                console.warn("Speech Synthesis not supported in this browser.");
            }
        }

        // --- AI Communication Logic ---
        async function sendToAI(userMessage) {
            hideErrorMessage();
            showLoading(true);

            // Add user message to chat history for context
            chatHistory.push({ role: "user", parts: [{ text: userMessage }] });

            try {
                const payload = {
                    // Send the full chat history for conversational context
                    contents: chatHistory,
                    generationConfig: {
                        temperature: 0.7, // Adjust as needed for creativity vs. focus
                        maxOutputTokens: 200,
                    },
                    safetySettings: [
                        { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" },
                        { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" },
                        { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" },
                        { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" },
                    ],
                };

                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`API error: ${response.status} - ${errorData.error.message || 'Unknown error'}`);
                }

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const aiResponse = result.candidates[0].content.parts[0].text;
                    addMessage(aiResponse, 'bot');
                    speakText(aiResponse);
                    // Add AI's response to chat history
                    chatHistory.push({ role: "model", parts: [{ text: aiResponse }] });
                    return aiResponse;
                } else {
                    const noResponseMsg = 'The AI did not generate a response. Please try rephrasing your question.';
                    addMessage(noResponseMsg, 'bot');
                    speakText(noResponseMsg);
                    chatHistory.push({ role: "model", parts: [{ text: noResponseMsg }] });
                    return noResponseMsg;
                }

            } catch (error) {
                console.error('Error sending message to AI:', error);
                const errorMsg = `Sorry, I encountered an error: ${error.message}. Please try again.`;
                showErrorMessage(errorMsg);
                addMessage(errorMsg, 'bot'); // Also add to chat for visibility
                speakText(errorMsg);
                return errorMsg;
            } finally {
                showLoading(false);
            }
        }

        // --- Lesson Progression Logic ---
        async function handleUserInput() {
            const userText = userInput.value.trim();
            if (userText === "") {
                return; // Don't send empty messages
            }

            addMessage(userText, 'user');
            userInput.value = ''; // Clear input field

            let promptForAI = ""; // The specific prompt based on lesson stage

            switch (lessonStage) {
                case 0: // Initial greeting and setting up the Spanish lesson
                    if (userText.toLowerCase().includes('hola')) {
                        promptForAI = `The user said "${userText}". They correctly said 'Hola'. Praise their progress! Now, let's learn how to say "Good morning" and "Good night". "Good morning" is 'Buenos días' and "Good night" is 'Buenas noches'. Please ask them to say 'Good morning' in Spanish.`;
                        lessonStage = 1;
                    } else if (userText.toLowerCase().includes('yes')) {
                        promptForAI = `The user said "${userText}". Great! Let's start with 'Hello' in Spanish. It's 'Hola'. Can you say 'Hola'?`;
                    } else {
                        promptForAI = `The user said "${userText}". You are an AI Language Tutor for Spanish. Remind them that we are learning greetings. 'Hello' in Spanish is 'Hola'. Ask them to try saying 'Hola'. Offer a small encouragement.`;
                    }
                    break;

                case 1: // Learning "Buenos días" and "Buenas noches"
                    if (userText.toLowerCase().includes('buenos dias')) {
                        promptForAI = `The user said "${userText}". They correctly said 'Buenos días'. Excellent! Now, let's learn to ask "How are you?". In Spanish, it's '¿Cómo estás?'. Please ask them '¿Cómo estás?' and guide them to respond with 'Estoy bien' (I am fine).`;
                        lessonStage = 2;
                    } else if (userText.toLowerCase().includes('buenas noches')) {
                        promptForAI = `The user said "${userText}". That's 'Good night'! While correct, we were focusing on 'Buenos días' (Good morning). Could you please try saying 'Buenos días' again?`;
                    } else {
                        promptForAI = `The user said "${userText}". They're trying to say 'Good morning' but made a mistake. Remind them that 'Good morning' is 'Buenos días'. Ask them to try again.`;
                    }
                    break;

                case 2: // Learning "¿Cómo estás?" and "Estoy bien"
                    if (userText.toLowerCase().includes('estoy bien')) {
                        promptForAI = `The user said "${userText}". They correctly said 'Estoy bien'. Fantastic! You're making great progress. Now, let's learn to introduce ourselves. To say "My name is [your name]" in Spanish, you say 'Me llamo [your name]'. For example, 'Me llamo Juan'. Please ask the user to introduce themselves, encouraging them to use 'Me llamo'.`;
                        lessonStage = 3;
                    } else if (userText.toLowerCase().includes('como estas') || userText.toLowerCase().includes('¿cómo estás?')) {
                        promptForAI = `The user said "${userText}". You just asked me that! Remember, I asked *you* '¿Cómo estás?'. The correct reply would be 'Estoy bien' (I am fine). Please try responding with 'Estoy bien'.`;
                    } else {
                        promptForAI = `The user said "${userText}". They made a mistake trying to say 'I am fine' in Spanish. Remind them that 'I am fine' is 'Estoy bien' and ask them '¿Cómo estás?' again, prompting for the correct response.`;
                    }
                    break;

                case 3: // Learning "Me llamo"
                    if (userText.toLowerCase().includes('me llamo')) {
                        promptForAI = `The user said "${userText}". They successfully introduced themselves! ¡Excelente! You've learned basic greetings, how to ask and respond to "How are you?", and how to introduce yourself. Would you like to review these lessons, or move on to a new topic like "ordering food" or "asking for directions"?`;
                        lessonStage = 4; // Move to a "free chat/topic selection" stage
                    } else {
                        promptForAI = `The user said "${userText}". They made a mistake trying to introduce themselves. Remind them that "My name is" is 'Me llamo', and encourage them to say "Me llamo [their name]".`;
                    }
                    break;

                default: // lessonStage >= 4: Free chat / Topic selection
                    promptForAI = `The user said "${userText}". You are an AI Language Tutor for Spanish. Continue the conversation naturally in Spanish or English, providing helpful language learning feedback. If they ask for a new topic, suggest "ordering food" or "asking for directions". If they want to review, ask what they'd like to practice. Encourage them to try speaking more Spanish.`;
                    break;
            }
            await sendToAI(promptForAI);
        }

        // --- Initial Chat Setup ---
        function initializeChatHistory() {
            // Reset chat display and history for a clean start
            chatDisplay.innerHTML = '';
            chatHistory = [
                { role: "user", parts: [{ text: "Hello, I want to learn Spanish." }] },
                { role: "model", parts: [{ text: "Hola! I'm your AI Language Tutor. I can help you learn Spanish. Ready to start with some basic greetings?" }] }
            ];
            lessonStage = 0; // Reset lesson stage

            // Display initial bot message
            addMessage(chatHistory[1].parts[0].text, 'bot');
            speakText(chatHistory[1].parts[0].text);
        }

        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            // Attach main modal event listeners once on DOM load
            closeTutorBtn.addEventListener('click', closeAITutorModal);
            aiTutorModal.addEventListener('click', (e) => {
                if (e.target === aiTutorModal) { // Close if clicked on overlay, not content
                    closeAITutorModal();
                }
            });

            // Attach chat input event listeners
            sendBtn.addEventListener('click', handleUserInput);
            userInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) { // Send on Enter, allow Shift+Enter for new line
                    e.preventDefault(); // Prevent default Enter behavior (new line)
                    handleUserInput();
                }
            });

            // Add auto-resize for textarea
            userInput.addEventListener('input', () => {
                userInput.style.height = 'auto'; // Reset height
                userInput.style.height = userInput.scrollHeight + 'px'; // Set to scroll height
            });
        });
    </script>
</body>
</html>
