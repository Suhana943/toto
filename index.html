<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Language Tutor</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Base Styles & Variables */
        :root {
            --primary-blue: #1691fd;
            --secondary-yellow: #ebab0c;
            --light-blue-bg: #d9eff8;
            --text-dark: #333;
            --text-light: #fff;
            --gray-text: #555;
            --border-radius-md: 20px;
            --border-radius-lg: 40px;
            --transition-speed: 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: "Poppins", sans-serif;
            line-height: 1.6;
            color: var(--text-dark);
            background-color: #f0f8ff; /* Light background */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .language-tutor-container {
            background-color: var(--text-light);
            border-radius: var(--border-radius-lg);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
            max-width: 700px;
            width: 100%;
            height: 700px; /* Fixed height for the tutor window */
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative; /* For loading indicator positioning */
        }

        .tutor-header {
            background-color: var(--primary-blue);
            color: var(--text-light);
            padding: 20px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1.3rem;
            font-weight: 600;
            border-top-left-radius: var(--border-radius-lg);
            border-top-right-radius: var(--border-radius-lg);
        }

        .tutor-header h3 {
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .tutor-header .fas {
            font-size: 1.1em;
        }

        .close-tutor-btn {
            background: none;
            border: none;
            color: var(--text-light);
            font-size: 1.5rem;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .close-tutor-btn:hover {
            transform: rotate(90deg);
        }

        .chat-display {
            flex-grow: 1;
            padding: 25px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
            font-size: 1rem;
            background-color: #fcfdff;
            scroll-behavior: smooth;
        }

        .message {
            padding: 15px 20px;
            border-radius: 25px;
            max-width: 80%;
            line-height: 1.5;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .bot-message {
            background-color: var(--light-blue-bg);
            align-self: flex-start;
            border-bottom-left-radius: 8px;
            color: var(--text-dark);
        }

        .user-message {
            background-color: var(--primary-blue);
            color: var(--text-light);
            align-self: flex-end;
            border-bottom-right-radius: 8px;
        }

        .tutor-input {
            display: flex;
            padding: 20px 25px;
            border-top: 1px solid #e0e0e0;
            background-color: var(--text-light);
            gap: 15px;
        }

        .tutor-input textarea {
            flex-grow: 1;
            border: 1px solid #ccc;
            border-radius: var(--border-radius-md);
            padding: 12px 18px;
            font-family: "Poppins", sans-serif;
            font-size: 1rem;
            min-height: 50px;
            max-height: 120px; /* Prevent it from getting too tall */
            resize: vertical;
            outline: none;
            transition: border-color var(--transition-speed), box-shadow var(--transition-speed);
        }

        .tutor-input textarea:focus {
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(22, 145, 253, 0.2);
        }

        .btn {
            padding: 12px 25px;
            border-radius: var(--border-radius-md);
            border: none;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            background-color: var(--secondary-yellow);
            color: var(--text-light);
            transition: all var(--transition-speed);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn:hover {
            background-color: #d89e0b;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .loading-indicator {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(255, 255, 255, 0.95);
            padding: 20px 30px;
            border-radius: var(--border-radius-md);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            font-weight: 500;
            color: var(--primary-blue);
            z-index: 10;
        }

        .loading-indicator i {
            margin-right: 10px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            color: #dc3545; /* Red for errors */
            margin-top: 15px;
            font-weight: 500;
            text-align: center;
            padding: 0 20px;
        }

        /* Responsive Adjustments */
        @media (max-width: 768px) {
            .language-tutor-container {
                width: 95%;
                height: 90vh; /* Adjust height for smaller screens */
                border-radius: var(--border-radius-md);
            }
            .tutor-header {
                font-size: 1.1rem;
                padding: 15px 20px;
                border-top-left-radius: var(--border-radius-md);
                border-top-right-radius: var(--border-radius-md);
            }
            .close-tutor-btn {
                font-size: 1.2rem;
            }
            .chat-display {
                padding: 15px;
                gap: 10px;
            }
            .message {
                padding: 12px 15px;
                font-size: 0.9rem;
            }
            .tutor-input {
                padding: 15px 20px;
                flex-direction: column;
                gap: 10px;
            }
            .tutor-input textarea {
                min-height: 40px;
                max-height: 80px;
            }
            .btn {
                width: 100%;
                padding: 10px 15px;
            }
            .loading-indicator {
                padding: 15px 20px;
                font-size: 0.9rem;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 10px;
            }
            .language-tutor-container {
                height: 95vh;
            }
            .tutor-header {
                font-size: 1rem;
            }
            .chat-display {
                font-size: 0.85rem;
            }
            .message {
                max-width: 90%;
            }
        }
    </style>
</head>
<body>
    <div class="language-tutor-container">
        <div class="tutor-header">
            <h3><i class="fas fa-language"></i> AI Language Tutor</h3>
            <button class="close-tutor-btn" aria-label="Close tutor"><i class="fas fa-times"></i></button>
        </div>
        <div class="chat-display" id="chatDisplay">
            <div class="message bot-message">Hola! I'm your AI Language Tutor. I can help you learn Spanish. Ready to start with some basic greetings?</div>
            <div class="message bot-message">Try saying "Hello" in Spanish!</div>
        </div>
        <div class="tutor-input">
            <textarea id="userInput" placeholder="Type your answer or question here..." rows="1"></textarea>
            <button id="sendBtn" class="btn"><i class="fas fa-paper-plane"></i> Send</button>
        </div>

        <div id="loadingIndicator" class="loading-indicator">
            <i class="fas fa-spinner"></i> AI is thinking...
        </div>
        <p id="errorMessage" class="error-message" style="display: none;"></p>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const chatDisplay = document.getElementById('chatDisplay');
            const userInput = document.getElementById('userInput');
            const sendBtn = document.getElementById('sendBtn');
            const loadingIndicator = document.getElementById('loadingIndicator');
            const errorMessage = document.getElementById('errorMessage');
            const closeTutorBtn = document.querySelector('.close-tutor-btn');

            // --- API Configuration (move to environment variables for production) ---
            // For a production app, never expose API keys directly in client-side code.
            // Use a backend proxy to handle API requests securely.
            // For this demonstration, we'll keep it here as per your original request,
            // but strongly advise moving it server-side for real applications.
            const API_KEY = "AIzaSyCBSJI95ouerTIu0gDmwnNPApN3lKqamiA"; // <<< IMPORTANT: Replace with your actual API key
            const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${AIzaSyCBSJI95ouerTIu0gDmwnNPApN3lKqamiA}`; // Using gemini-pro

            // Initial chat history for the AI model
            // This helps the AI maintain context throughout the conversation.
            let chatHistory = [
                { role: "user", parts: [{ text: "Hello, I want to learn Spanish." }] },
                { role: "model", parts: [{ text: "Hola! I'm your AI Language Tutor. I can help you learn Spanish. Ready to start with some basic greetings?" }] },
                { role: "user", parts: [{ text: "Yes, I am ready." }] },
                { role: "model", parts: [{ text: "Great! Let's start with 'Hello' in Spanish. It's 'Hola'. Can you say 'Hola'?" }] }
            ];

            // Simple state to guide the lesson flow (for hackathon demo purposes)
            let lessonStage = 0; // 0: Greetings, 1: Asking how are you, 2: Introducing oneself

            /**
             * Adds a message to the chat display.
             * @param {string} text - The message content.
             * @param {string} sender - 'user' or 'bot'.
             */
            function addMessage(text, sender) {
                const messageDiv = document.createElement('div');
                messageDiv.classList.add('message', `${sender}-message`);
                messageDiv.textContent = text;
                chatDisplay.appendChild(messageDiv);
                chatDisplay.scrollTop = chatDisplay.scrollHeight; // Auto-scroll to bottom
            }

            /**
             * Speaks text aloud using Web Speech API.
             * @param {string} text - The text to speak.
             */
            function speakText(text) {
                if ('speechSynthesis' in window) {
                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.lang = 'es-ES'; // Set language to Spanish for AI responses
                    window.speechSynthesis.speak(utterance);
                } else {
                    console.warn("Speech Synthesis not supported in this browser.");
                }
            }

            /**
             * Sends a message to the AI and processes the response.
             * @param {string} userMessage - The user's input to send to the AI.
             */
            async function sendToAI(userMessage) {
                errorMessage.style.display = 'none'; // Hide any previous errors
                loadingIndicator.style.display = 'flex'; // Show loading indicator

                // Add user message to chat history
                // Note: The `promptForAI` is what gets added as the "user" role to the chatHistory,
                // not the raw `userText` from the input field, to guide the AI better.
                chatHistory.push({ role: "user", parts: [{ text: userMessage }] });

                try {
                    const payload = {
                        contents: chatHistory,
                        // Add generation configurations if needed, e.g., temperature, topP, topK
                        generationConfig: {
                            temperature: 0.7, // A bit creative but not too wild
                            maxOutputTokens: 200, // Limit response length
                        },
                        safetySettings: [
                            { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" },
                            { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" },
                            { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" },
                            { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" },
                        ],
                    };

                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(`API error: ${response.status} - ${errorData.error.message || 'Unknown error'}`);
                    }

                    const result = await response.json();

                    // Check for candidates and text content based on Gemini API response structure
                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        const aiResponse = result.candidates[0].content.parts[0].text;
                        addMessage(aiResponse, 'bot');
                        speakText(aiResponse);
                        chatHistory.push({ role: "model", parts: [{ text: aiResponse }] });
                        return aiResponse;
                    } else {
                        const noResponseMsg = 'The AI did not generate a response. Please try rephrasing your question.';
                        addMessage(noResponseMsg, 'bot');
                        speakText(noResponseMsg);
                        chatHistory.push({ role: "model", parts: [{ text: noResponseMsg }] });
                        return noResponseMsg;
                    }

                } catch (error) {
                    console.error('Error sending message to AI:', error);
                    const errorMsg = `Sorry, I encountered an error: ${error.message}. Please try again.`;
                    errorMessage.textContent = errorMsg;
                    errorMessage.style.display = 'block';
                    addMessage(errorMsg, 'bot');
                    speakText(errorMsg);
                    return errorMsg;
                } finally {
                    loadingIndicator.style.display = 'none'; // Hide loading indicator
                }
            }

            /**
             * Handles user input, determines the AI's prompt, and sends it.
             */
            async function handleUserInput() {
                const userText = userInput.value.trim();
                if (userText === "") {
                    return; // Don't send empty messages
                }

                addMessage(userText, 'user');
                userInput.value = ''; // Clear input field

                let promptForAI = ""; // This will be the specific instruction for the AI

                // More sophisticated lesson logic
                switch (lessonStage) {
                    case 0: // Greetings lesson: learning "Hola"
                        if (userText.toLowerCase().includes('hola')) {
                            promptForAI = `The user said "${userText}". They correctly said 'Hola'. Praise their progress! Now, let's learn how to say "Good morning" and "Good night". "Good morning" is 'Buenos días' and "Good night" is 'Buenas noches'. Please ask them to say 'Good morning' in Spanish.`;
                            lessonStage = 1;
                        } else {
                            promptForAI = `The user said "${userText}". They made a mistake trying to say 'Hello' in Spanish. Remind them gently that 'Hello' is 'Hola'. Provide the correct spelling and pronunciation hint, and ask them to try saying 'Hola' again. Offer a small encouragement.`;
                        }
                        break;
                    case 1: // Learning "Buenos días" and "Buenas noches"
                        if (userText.toLowerCase().includes('buenos dias')) {
                            promptForAI = `The user said "${userText}". They correctly said 'Buenos días'. Excellent! Now, let's learn to ask "How are you?". In Spanish, it's '¿Cómo estás?'. Please ask them '¿Cómo estás?' and guide them to respond with 'Estoy bien' (I am fine).`;
                            lessonStage = 2;
                        } else if (userText.toLowerCase().includes('buenas noches')) {
                            promptForAI = `The user said "${userText}". That's 'Good night'! While correct, we were focusing on 'Buenos días' (Good morning). Could you please try saying 'Buenos días' again?`;
                        } else {
                            promptForAI = `The user said "${userText}". They're trying to say 'Good morning' but made a mistake. Remind them that 'Good morning' is 'Buenos días'. Ask them to try again.`;
                        }
                        break;
                    case 2: // Learning "¿Cómo estás?" and "Estoy bien"
                        if (userText.toLowerCase().includes('estoy bien')) {
                            promptForAI = `The user said "${userText}". They correctly said 'Estoy bien'. Fantastic! You're making great progress. Now, let's learn to introduce ourselves. To say "My name is [your name]" in Spanish, you say 'Me llamo [your name]'. For example, 'Me llamo Juan'. Please ask the user to introduce themselves, encouraging them to use 'Me llamo'.`;
                            lessonStage = 3;
                        } else if (userText.toLowerCase().includes('como estas') || userText.toLowerCase().includes('¿cómo estás?')) {
                             promptForAI = `The user said "${userText}". You just asked me that! Remember, I asked *you* '¿Cómo estás?'. The correct reply would be 'Estoy bien' (I am fine). Please try responding with 'Estoy bien'.`;
                        }
                        else {
                            promptForAI = `The user said "${userText}". They made a mistake trying to say 'I am fine' in Spanish. Remind them that 'I am fine' is 'Estoy bien' and ask them '¿Cómo estás?' again, prompting for the correct response.`;
                        }
                        break;
                    case 3: // Learning "Me llamo"
                        if (userText.toLowerCase().includes('me llamo')) {
                            promptForAI = `The user said "${userText}". They successfully introduced themselves! ¡Excelente! You've learned basic greetings, how to ask and respond to "How are you?", and how to introduce yourself. Would you like to review these lessons, or move on to a new topic like "ordering food" or "asking for directions"?`;
                            lessonStage = 4; // End of this structured flow
                        } else {
                            promptForAI = `The user said "${userText}". They made a mistake trying to introduce themselves. Remind them that "My name is" is 'Me llamo', and encourage them to say "Me llamo [their name]".`;
                        }
                        break;
                    default: // General conversation or review
                        promptForAI = `The user said "${userText}". You are an AI Language Tutor for Spanish. Continue the conversation naturally in Spanish or English, providing helpful language learning feedback. If they ask for a new topic, suggest "ordering food" or "asking for directions". If they want to review, ask what they'd like to practice.`;
                        break;
                }

                // Send the generated prompt to the AI
                await sendToAI(promptForAI);
            }

            // --- Event Listeners ---
            sendBtn.addEventListener('click', handleUserInput);

            userInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) { // Allow Shift+Enter for new line
                    e.preventDefault(); // Prevent default new line behavior
                    handleUserInput();
                }
            });

            // Close button functionality
            if (closeTutorBtn) {
                closeTutorBtn.addEventListener('click', () => {
                    // You might hide the tutor container or navigate away
                    document.querySelector('.language-tutor-container').style.display = 'none';
                    // Optionally, stop speech synthesis when closing
                    if ('speechSynthesis' in window) {
                        window.speechSynthesis.cancel();
                    }
                });
            }
        });
    </script>
</body>
</html>
